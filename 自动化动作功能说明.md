# 高级定时闹钟 - 自动化动作执行功能

## 📋 功能概述

此次更新为高级定时闹钟添加了强大的自动化执行能力，使闹钟不仅能够提醒您，还能在触发时自动执行各种任务。

### 核心功能

1. **多种动作类型支持**
   - 🔔 仅提醒 - 传统的闹钟提醒功能
   - 🌐 打开网址 - 自动在浏览器中打开指定URL
   - ⚙️ 执行系统命令 - 运行Windows命令或批处理脚本
   - 🐍 运行Python脚本 - 执行Python程序

2. **完善的用户界面**
   - 直观的动作类型选择器（Radio Button）
   - 根据动作类型动态显示对应的参数输入框
   - 参数验证和测试功能
   - 超时时间可配置（5-300秒）

3. **强大的日志系统**
   - 基于Serilog的结构化日志记录
   - 自动按日期分割日志文件
   - 详细记录每次执行的结果、耗时和错误信息
   - 日志文件存储在 `%AppData%\AdvancedClock\logs\`

4. **安全与错误处理**
   - URL格式验证
   - 危险命令拦截（如 format、del /s 等）
   - Python脚本文件存在性检查
   - 执行超时自动终止
   - 异常捕获和友好的错误提示

## 🏗️ 技术架构

### 新增核心类

#### 1. 动作执行器（Actions命名空间）

```
ActionExecutor (抽象基类)
├── UrlActionExecutor - URL打开执行器
├── CommandActionExecutor - 系统命令执行器
└── PythonScriptActionExecutor - Python脚本执行器
```

**特性**:
- 统一的执行接口 `ExecuteAsync()`
- 参数验证方法 `ValidateParameter()`
- 异步执行支持
- 超时控制
- 详细的执行结果返回

#### 2. 日志服务（LogService）

**特性**:
- 单例模式设计
- 自动创建日志目录
- 按日期滚动日志文件
- 保留最近30天日志
- UTF-8编码支持中文

#### 3. 数据模型扩展（AlarmModel）

**新增属性**:
- `ActionType` - 动作类型枚举
- `ActionParameter` - 动作参数（URL/命令/脚本路径）
- `ActionTimeoutSeconds` - 执行超时时间
- `ActionTypeText` - 动作类型显示文本

### 界面更新

#### AlarmEditDialog 编辑对话框
- 新增"触发时执行动作"分组框
- 动作类型Radio Button组
- 动态显示的参数输入区
  - URL输入框 + 测试按钮
  - 多行命令输入框
  - Python脚本文件选择器
- 超时时间设置

#### MainWindow 主窗口
- 闹钟列表新增"动作"列显示动作类型
- 新增"📋 查看日志"按钮
- 闹钟触发时自动执行配置的动作
- 动作执行失败时显示错误对话框

## 📦 依赖包

项目新增了以下NuGet包：

```xml
<PackageReference Include="Serilog" Version="3.1.1" />
<PackageReference Include="Serilog.Sinks.File" Version="5.0.0" />
```

## 🎨 UI/UX 设计

### 动作配置区域
- 采用GroupBox分组，标题带齿轮图标⚙️
- 蓝色边框突出显示（#2196F3）
- Radio Button带表情符号，易于识别
- 参数输入区根据选择动态显示/隐藏
- 测试按钮使用微软蓝色（#0078D4）

### 主窗口更新
- 新增紫色的"查看日志"按钮（#673AB7）
- 闹钟列表新增"动作"列，宽度100px
- 保持与现有UI风格的一致性

## 🔧 代码示例

### 使用动作执行器

```csharp
// 创建URL执行器
var urlExecutor = new UrlActionExecutor();

// 验证参数
var validationError = urlExecutor.ValidateParameter("https://www.baidu.com");
if (validationError != null)
{
    // 处理验证错误
}

// 执行动作
var result = await urlExecutor.ExecuteAsync("https://www.baidu.com", 30);
if (result.Success)
{
    Console.WriteLine($"执行成功: {result.Message}");
}
else
{
    Console.WriteLine($"执行失败: {result.ErrorDetails}");
}
```

### 记录日志

```csharp
var logService = LogService.Instance;

// 记录信息日志
logService.LogInfo("操作成功", "详细信息");

// 记录错误日志
logService.LogError("操作失败", "错误详情", exception);

// 记录闹钟触发
logService.LogAlarmTriggered("闹钟名称", DateTime.Now);

// 记录动作执行
logService.LogActionExecution(
    alarmName: "测试闹钟",
    actionType: "打开网址",
    actionParameter: "https://www.baidu.com",
    success: true,
    message: "成功打开网址",
    duration: TimeSpan.FromSeconds(0.85)
);
```

## 📂 文件结构

```
AdvancedClock/
├── src/
│   ├── Actions/                    # 动作执行器
│   │   ├── ActionExecutor.cs       # 抽象基类
│   │   ├── UrlActionExecutor.cs
│   │   ├── CommandActionExecutor.cs
│   │   └── PythonScriptActionExecutor.cs
│   ├── Services/
│   │   └── LogService.cs           # 日志服务
│   ├── AlarmModel.cs               # 扩展了动作相关属性
│   ├── AlarmEditDialog.xaml        # 新增动作配置UI
│   ├── AlarmEditDialog.xaml.cs     # 新增动作处理逻辑
│   ├── MainWindow.xaml             # 新增日志按钮和动作列
│   ├── MainWindow.xaml.cs          # 集成动作执行
│   └── ValueConverters.cs          # 新增EnumToBoolConverter
├── test_python_script.py           # Python测试脚本
├── 功能测试指南.md                  # 测试指南
└── 自动化动作功能说明.md            # 本文档
```

## 🔐 安全特性

### 1. 命令执行安全
- 危险命令黑名单过滤
- 不允许执行包含以下关键字的命令：
  - `format` - 格式化磁盘
  - `del /s` - 递归删除
  - `rd /s` - 递归删除目录
  - `rmdir /s` - 递归删除目录

### 2. 参数验证
- URL必须以 `http://` 或 `https://` 开头
- Python脚本必须是 `.py` 文件且存在
- 所有参数不能为空

### 3. 超时控制
- 所有动作执行都有超时限制（5-300秒）
- 超时后自动终止进程
- 防止程序无限等待

### 4. 异常处理
- 所有执行过程都包裹在try-catch块中
- 异常信息详细记录到日志
- UI线程安全的错误提示

## 📊 性能考虑

1. **异步执行**: 所有动作执行都是异步的，不会阻塞UI线程
2. **进程管理**: 使用 `Process.Start()` 启动外部程序，超时自动清理
3. **日志性能**: Serilog高性能异步日志，不影响主程序运行
4. **内存管理**: 执行器不保持状态，每次使用完即释放

## 🎯 使用场景

### 1. 工作提醒
- 定时打开会议链接
- 提醒时自动打开项目文档

### 2. 系统管理
- 定时执行备份命令
- 定时清理临时文件
- 定时重启服务

### 3. 数据处理
- 定时运行数据采集脚本
- 定时生成报表
- 定时数据同步

### 4. 学习提醒
- 定时打开学习网站
- 定时运行背单词程序
- 定时播放学习视频

## 🚀 未来扩展建议

1. **更多动作类型**
   - 发送邮件
   - 发送HTTP请求
   - 运行其他脚本语言（如PowerShell、Bash）
   - 播放音频文件

2. **高级日志查看器**
   - 内置日志查看窗口
   - 日志筛选和搜索
   - 日志导出功能
   - 实时日志监控

3. **动作链**
   - 支持一个闹钟执行多个动作
   - 动作之间的依赖关系
   - 条件执行

4. **云同步**
   - 闹钟配置云端备份
   - 多设备同步

## 📝 开发说明

### 构建项目

```bash
# 还原依赖
dotnet restore

# 构建Debug版本
dotnet build

# 构建Release版本
dotnet build --configuration Release

# 运行
dotnet run
```

### 运行测试

```bash
# 运行编译后的程序
.\bin\Release\net8.0-windows\AdvancedClock.exe

# 或使用dotnet run
dotnet run --project AdvancedClock.csproj
```

## 📞 支持与反馈

如果您在使用过程中遇到任何问题或有改进建议，请查看日志文件获取详细信息：

- **日志位置**: `%AppData%\AdvancedClock\logs\`
- **日志格式**: `alarm-log-yyyyMMdd.txt`
- **查看方式**: 点击主窗口"📋 查看日志"按钮

## 📄 许可证

本项目仅供学习和个人使用。

---

**版本**: 3.0  
**更新日期**: 2025-12-10  
**开发框架**: .NET 8.0 + WPF  
**日志框架**: Serilog 3.1.1  

🎉 **享受全新的自动化闹钟体验！**
