# GitHub Actions workflow for AdvancedClock WPF Application
# This workflow builds, tests, and releases the WPF desktop application

name: .NET WPF Desktop Build & Release

on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ]  # è§¦å‘ç‰ˆæœ¬æ ‡ç­¾å‘å¸ƒ
  pull_request:
    branches: [ "main", "master" ]

env:
  # é¡¹ç›®é…ç½®
  PROJECT_NAME: AdvancedClock
  SOLUTION_FILE: AdvancedClock.sln
  PROJECT_FILE: AdvancedClock.csproj
  
  # .NET é…ç½®
  DOTNET_VERSION: 7.0.x
  
  # æž„å»ºé…ç½®
  PUBLISH_OUTPUT_DIR: ./publish
  ARTIFACT_RETENTION_DAYS: 30
  
  # å‘å¸ƒé…ç½®
  RELEASE_CONFIGURATION: Release

jobs:
  build:
    strategy:
      matrix:
        configuration: [Debug, Release]

    runs-on: windows-latest

    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # å®‰è£… .NET
    - name: Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # æ¢å¤ NuGet åŒ…
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    # æž„å»ºé¡¹ç›®
    - name: Build
      run: dotnet build ${{ env.SOLUTION_FILE }} --configuration ${{ matrix.configuration }} --no-restore

    # å‘å¸ƒåº”ç”¨ç¨‹åºï¼ˆåˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼‰
    - name: Publish
      run: dotnet publish ${{ env.PROJECT_FILE }} --configuration ${{ matrix.configuration }} --output ${{ env.PUBLISH_OUTPUT_DIR }}/${{ matrix.configuration }} --no-build --self-contained false

    # åˆ›å»ºå‘å¸ƒåŒ…ï¼ˆä»… Release é…ç½®ï¼‰
    - name: Create Release Package
      if: matrix.configuration == 'Release'
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        $releaseDir = "${{ env.PUBLISH_OUTPUT_DIR }}/Release"
        $packageDir = "${{ env.PUBLISH_OUTPUT_DIR }}/Package"
        New-Item -ItemType Directory -Force -Path $packageDir
        
        # å¤åˆ¶å¿…è¦æ–‡ä»¶
        Copy-Item -Path "$releaseDir/*" -Destination $packageDir -Recurse -Force
        
        # åˆ›å»º ZIP åŒ…
        $zipName = "${{ env.PROJECT_NAME }}-v${{ github.ref_name }}-windows-x64.zip"
        if ("${{ github.ref_type }}" -ne "tag") {
          $zipName = "${{ env.PROJECT_NAME }}-${{ github.sha }}-windows-x64.zip"
        }
        
        Compress-Archive -Path "$packageDir/*" -DestinationPath "${{ env.PUBLISH_OUTPUT_DIR }}/$zipName" -Force
        
        # è¾“å‡ºåŒ…ä¿¡æ¯
        echo "PACKAGE_NAME=$zipName" >> $env:GITHUB_ENV
        echo "PACKAGE_PATH=${{ env.PUBLISH_OUTPUT_DIR }}/$zipName" >> $env:GITHUB_ENV
      shell: powershell

    # ä¸Šä¼ æž„å»ºäº§ç‰©
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ matrix.configuration }}
        path: ${{ env.PUBLISH_OUTPUT_DIR }}/${{ matrix.configuration }}
        retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

    # ä¸Šä¼ å‘å¸ƒåŒ…ï¼ˆä»… Release é…ç½®ï¼‰
    - name: Upload Release Package
      if: matrix.configuration == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-Package
        path: ${{ env.PACKAGE_PATH }}
        retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  # è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Releaseï¼ˆä»…å½“æŽ¨é€æ ‡ç­¾æ—¶ï¼‰
  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ä¸‹è½½æž„å»ºäº§ç‰©
    - name: Download Release Package
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-Package
        path: ./release-assets

    # èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
    - name: Get Version Info
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    # ç”Ÿæˆæ›´æ–°æ—¥å¿—
    - name: Generate Changelog
      id: changelog
      run: |
        # èŽ·å–æœ€æ–°çš„æ ‡ç­¾
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LATEST_TAG" ]; then
          # å¦‚æžœæ²¡æœ‰ä¹‹å‰çš„æ ‡ç­¾ï¼ŒèŽ·å–æ‰€æœ‰æäº¤
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          # èŽ·å–è‡ªä¸Šæ¬¡æ ‡ç­¾ä»¥æ¥çš„æäº¤
          CHANGELOG=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
        fi
        
        # å¦‚æžœæ²¡æœ‰æ›´æ”¹ï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯
        if [ -z "$CHANGELOG" ]; then
          CHANGELOG="- ç‰ˆæœ¬æ›´æ–°å’Œbugä¿®å¤"
        fi
        
        # åˆ›å»ºå®Œæ•´çš„å‘å¸ƒè¯´æ˜Ž
        cat > release_notes.md << EOF
        ## ðŸš€ ${{ steps.version.outputs.version }} ç‰ˆæœ¬æ›´æ–°
        
        ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        - **Windows ç”¨æˆ·**ï¼šä¸‹è½½ \`${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}-windows-x64.zip\`
        - è§£åŽ‹åŽè¿è¡Œ \`${{ env.PROJECT_NAME }}.exe\` å³å¯ä½¿ç”¨
        - éœ€è¦å®‰è£… .NET 7.0 Runtimeï¼ˆå¦‚æžœç³»ç»Ÿä¸­æ²¡æœ‰ï¼‰
        
        ### ðŸ”„ æ›´æ–°å†…å®¹
        $CHANGELOG
        
        ### ðŸ’¡ ä½¿ç”¨æç¤º
        - é¦–æ¬¡è¿è¡Œä¼šåˆ›å»ºç¤ºä¾‹é—¹é’Ÿ
        - æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°ç”¨æˆ·ç›®å½•ï¼š\`%AppData%\\${{ env.PROJECT_NAME }}\`
        - æ”¯æŒå¼€æœºè‡ªå¯åŠ¨å’Œç³»ç»Ÿæ‰˜ç›˜åŠŸèƒ½
        
        ### ðŸ› é—®é¢˜åé¦ˆ
        å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚
        EOF
        
        echo "Generated release notes:"
        cat release_notes.md

    # åˆ›å»º GitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: ${{ env.PROJECT_NAME }} ${{ steps.version.outputs.version }}
        body_path: release_notes.md
        files: |
          ./release-assets/*.zip
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
